<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ClaimPX Telegram Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    #profile { display: none; margin-top: 2rem; }
    img { border-radius: 50%; width: 100px; height: 100px; }
    #debug { margin-top: 2rem; padding: 1rem; background-color: #f4f4f4; border: 1px solid #ccc; white-space: pre-wrap; font-family: monospace; }
  </style>
</head>
<body>
  <h2>Login with Telegram</h2>

  <!-- Telegram Login Widget -->
  <script async src="https://telegram.org/js/telegram-widget.js?7"
          data-telegram-login="uxxucc_bot"
          data-size="large"
          data-userpic="true"
          data-request-access="write"
          data-on-auth="onTelegramAuth">
  </script>

  <!-- Show User Profile Info -->
  <div id="profile">
    <h3 id="name"></h3>
    <p id="time"></p>
    <img id="photo" alt="Profile Photo">
    <p>Points: <span id="points">0</span></p>
  </div>

  <!-- Debugging Area -->
  <div id="debug"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-analytics.js"></script>

  <!-- Firebase + Telegram Auth Script -->
  <script>
    // Function to add debug messages to the webpage and console
    function debug(message) {
      const debugDiv = document.getElementById('debug');
      debugDiv.innerText += `${message}\n`; // Append message to debug area
      console.log(message);  // Also log to the browser console
    }

    // Log that script is running
    debug("Initializing the script...");

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDD0mTSuECptBeNzKpiaCDbbCJIoW9SiTg",
      authDomain: "claimpx.firebaseapp.com",
      projectId: "claimpx",
      storageBucket: "claimpx.firebasestorage.app",
      messagingSenderId: "1012471480360",
      appId: "1:1012471480360:web:3b16bc6acc6adcf371b51d",
      measurementId: "G-NYK5SSMCF3"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    firebase.analytics();

    // Log when Telegram widget is loaded
    window.onload = function() {
      debug("Telegram widget script has loaded.");
    }

    // Telegram login callback
    async function onTelegramAuth(user) {
      debug("onTelegramAuth triggered...");

      try {
        // Log the Telegram user object to debug area
        debug("Telegram user object:");
        debug(JSON.stringify(user, null, 2));  // Display user details

        // Prevent page refresh (important for single-page apps)
        if (event) {
          event.preventDefault();
        }

        // Access Firestore to store/retrieve user data
        const userRef = db.collection("telegram_users").doc(String(user.id));
        const now = new Date().toLocaleString();

        // Fetch current user data if exists
        const userDoc = await userRef.get();
        let points = 0;

        if (userDoc.exists) {
          debug("User found in Firestore. Retrieving points...");
          points = userDoc.data().points || 0;
        }

        // Add 100 points
        points += 100;
        debug(`Adding 100 points. New total: ${points}`);

        // Save user data to Firestore with updated points
        await userRef.set({
          id: user.id,
          first_name: user.first_name,
          username: user.username || null,
          photo_url: user.photo_url || null,
          login_time: firebase.firestore.FieldValue.serverTimestamp(),
          points: points
        });

        debug("User saved to Firestore with points:", points);

        // Show user profile on the page
        document.getElementById("name").innerText = `Hello, ${user.first_name}`;
        document.getElementById("time").innerText = `Login Time: ${now}`;
        document.getElementById("photo").src = user.photo_url || 'default-avatar.png';  // Fallback image if no photo
        document.getElementById("points").innerText = points;
        document.getElementById("profile").style.display = "block";

      } catch (error) {
        debug("Login failed:", error);
        alert("Error during login. Check console.");
      }
    }

    debug("Firebase and Telegram widget initialized.");
  </script>
</body>
</html>
