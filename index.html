<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ClaimPX Telegram Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2rem; }
    #profile { display: none; margin-top: 2rem; }
    img { border-radius: 50%; width: 100px; height: 100px; }
  </style>
</head>
<body>
  <h2>Login with Telegram</h2>

  <!-- Telegram Login Widget -->
  <script async src="https://telegram.org/js/telegram-widget.js?7"
          data-telegram-login="uxxucc_bot"
          data-size="large"
          data-userpic="true"
          data-request-access="write"
          data-on-auth="onTelegramAuth">
  </script>

  <!-- Show User Profile Info -->
  <div id="profile">
    <h3 id="name"></h3>
    <p id="time"></p>
    <img id="photo" alt="Profile Photo">
    <p>Points: <span id="points">0</span></p>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.7.1/firebase-analytics.js"></script>

  <!-- Firebase + Telegram Auth Script -->
  <script>
    console.log("Loading Firebase...");

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDD0mTSuECptBeNzKpiaCDbbCJIoW9SiTg",
      authDomain: "claimpx.firebaseapp.com",
      projectId: "claimpx",
      storageBucket: "claimpx.firebasestorage.app",
      messagingSenderId: "1012471480360",
      appId: "1:1012471480360:web:3b16bc6acc6adcf371b51d",
      measurementId: "G-NYK5SSMCF3"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    firebase.analytics();

    // Telegram login callback
    async function onTelegramAuth(user) {
      try {
        console.log("Telegram user logged in:", user);

        const userRef = db.collection("telegram_users").doc(String(user.id));
        const now = new Date().toLocaleString();

        // Fetch current user data if exists
        const userDoc = await userRef.get();
        let points = 0;

        if (userDoc.exists) {
          // If user exists, retrieve current points
          points = userDoc.data().points || 0;
        }

        // Add 100 points
        points += 100;

        // Save user data to Firestore with updated points
        await userRef.set({
          id: user.id,
          first_name: user.first_name,
          username: user.username || null,
          photo_url: user.photo_url || null,
          login_time: firebase.firestore.FieldValue.serverTimestamp(),
          points: points
        });

        console.log("User saved to Firestore with points:", points);

        // Show user profile
        document.getElementById("name").innerText = `Hello, ${user.first_name}`;
        document.getElementById("time").innerText = `Login Time: ${now}`;
        document.getElementById("photo").src = user.photo_url || 'default-avatar.png'; // fallback image
        document.getElementById("points").innerText = points;
        document.getElementById("profile").style.display = "block";

      } catch (error) {
        console.error("Login failed:", error);
        alert("Error during login. Check console.");
      }
    }

    console.log("Telegram widget loaded.");
  </script>
</body>
</html>
